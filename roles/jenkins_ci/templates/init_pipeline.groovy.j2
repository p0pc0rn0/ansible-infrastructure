import jenkins.model.Jenkins
import org.jenkinsci.plugins.workflow.job.WorkflowJob
import org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition

Jenkins jenkins = Jenkins.get()
String jobName = "{{ jenkins_pipeline_name }}"
String pipelineScript = """
pipeline {
  agent any
  environment {
    DOCKER_IMAGE = "demo-app:${env.BUILD_NUMBER}"
  }
  options {
    timestamps()
  }
  stages {
    stage('Checkout') {
      steps {
        git url: '{{ jenkins_pipeline_repo_url }}', branch: '{{ jenkins_pipeline_repo_branch }}'
      }
    }
    stage('Build Docker image') {
      steps {
        sh 'docker build -t $DOCKER_IMAGE .'
      }
    }
    stage('Unit tests') {
      steps {
        sh 'docker run --rm $DOCKER_IMAGE pytest || echo "Tests failed or not present"'
      }
    }
  }
  post {
    always {
      sh 'docker image ls $DOCKER_IMAGE || true'
    }
  }
}
"""

if (jenkins.getItem(jobName) == null) {
    WorkflowJob job = jenkins.createProject(WorkflowJob, jobName)
    job.setDefinition(new CpsFlowDefinition(pipelineScript, true))
    job.save()
}
